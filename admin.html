<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemi Mart | Master Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #1a2332; --orange: #e68a00; --green: #2e7d32; --edit-blue: #0275d8; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; display: flex; flex-direction: column; }
        
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .auth-card { background: white; padding: 40px; border-radius: 15px; text-align: center; color: var(--blue); width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .pass-container { position: relative; margin: 20px 0; }
        .pass-container input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; padding-right: 40px; }
        .pass-container i { position: absolute; right: 10px; top: 12px; cursor: pointer; color: #888; }
        
        header { background: var(--blue); color: white; padding: 15px; text-align: center; }
        .stats-container { display: flex; justify-content: center; gap: 20px; padding: 20px; background: #fff; border-bottom: 1px solid #eee; }
        .stat-box { background: #fff; border: 1px solid #ddd; padding: 15px 30px; border-radius: 10px; text-align: center; min-width: 150px; }
        .stat-box h2 { margin: 5px 0; color: var(--orange); }
        .stat-box p { margin: 0; font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; padding: 15px; background: #fff; }
        .tab-btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #eee; transition: 0.3s; }
        .active-tab { background: var(--orange); color: white; }
        
        .container { padding: 20px; max-width: 1400px; margin: auto; width: 98%; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 14px; border: 1px solid #f0f0f0; text-align: left; font-size: 13px; }
        th { background: #f8f9fa; color: var(--blue); font-weight: 800; }
        
        input, select, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 8px 0; width: 100%; box-sizing: border-box; font-size: 14px; }
        input:focus, textarea:focus { border-color: var(--orange); outline: none; box-shadow: 0 0 5px rgba(230, 138, 0, 0.2); }

        .btn-delete { color: #d32f2f; background: none; border: none; cursor: pointer; font-weight: bold; font-size: 16px; padding: 5px; }
        .btn-edit { color: var(--edit-blue); background: #e3f2fd; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; margin-right: 10px; }
        .prod-img-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }

        #form-title { color: var(--blue); border-bottom: 3px solid var(--orange); padding-bottom: 5px; margin-bottom: 20px; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <i class="fas fa-user-shield" style="font-size: 45px; color: var(--orange);"></i>
        <h2 style="margin: 15px 0 5px;">Admin Login</h2>
        <p style="font-size: 12px; color: #666; margin-bottom: 20px;">The Nemi Mart Management System</p>
        <div class="pass-container">
            <input type="password" id="admin_pass" placeholder="Enter Admin Access Code">
            <i class="fas fa-eye" id="togglePass" onclick="toggleVisibility()"></i>
        </div>
        <button class="tab-btn active-tab" style="width: 100%; padding: 15px;" onclick="checkAuth()">Authorize Access</button>
    </div>
</div>

<header>
    <h1>THE NEMI MART ADMIN</h1>
    <p><i class="fas fa-cog fa-spin"></i> Central Inventory & Orders Management</p>
</header>

<div class="stats-container">
    <div class="stat-box"><p>Total Sales Revenue</p><h2 id="total-revenue">₹0</h2></div>
    <div class="stat-box"><p>Order Volume</p><h2 id="total-orders">0</h2></div>
    <div class="stat-box"><p>Active Inventory</p><h2 id="total-products">0</h2></div>
</div>

<div class="nav-tabs">
    <button class="tab-btn active-tab" id="tab-orders" onclick="openTab('orders')"><i class="fas fa-shopping-cart"></i> Manage Orders</button>
    <button class="tab-btn" id="tab-products" onclick="openTab('products')"><i class="fas fa-boxes"></i> Product Inventory</button>
</div>

<div class="container">
    <div id="orders-sec">
        <div class="card" style="overflow-x:auto;">
            <h3><i class="fas fa-list-ul" style="color:var(--orange)"></i> Recent Customer Orders</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Order Items</th>
                        <th>Payment Detail</th>
                        <th>Order Status</th>
                        <th>Shipping Info</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="order-rows"></tbody>
            </table>
        </div>
    </div>

    <div id="products-sec" style="display:none;">
        <div class="card">
            <h3 id="form-title">Add New Product</h3>
            <input type="hidden" id="edit-p-id">
            
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                <div>
                    <label style="font-size:12px; font-weight:bold;">Product Title</label>
                    <input type="text" id="p_name" placeholder="E.g. Pure Sandalwood Oil">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold;">MRP (Original)</label>
                    <input type="number" id="p_original" placeholder="₹000">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold;">Selling Price</label>
                    <input type="number" id="p_price" placeholder="₹000">
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                <div>
                    <label style="font-size:12px; font-weight:bold;">Category</label>
                    <input type="text" id="p_category" placeholder="Organic / Pure / Oils">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold;">Stock Availability</label>
                    <select id="p_stock">
                        <option value="In Stock">In Stock</option>
                        <option value="Out of Stock">Out of Stock</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold;">Shipping Policy</label>
                    <select id="p_free_shipping">
                        <option value="true">Enable Free Delivery</option>
                        <option value="false">Paid Delivery</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 10px;">
                <label style="font-size:12px; font-weight:bold;">Product Image URL</label>
                <input type="text" id="p_img" placeholder="Paste Google Drive or Direct Image Link" oninput="document.getElementById('img-preview-box').src = this.value">
                <img id="img-preview-box" src="" style="max-height: 80px; margin-top: 5px; border-radius: 5px; border: 1px solid #eee;">
            </div>

            <div style="margin-top: 10px;">
                <label style="font-size:12px; font-weight:bold;">Detailed Description (Shown in View Details page)</label>
                <textarea id="p_description" placeholder="Write full details, benefits, and usage of the product..." rows="6"></textarea>
            </div>
            
            <div style="display:flex; gap:10px; margin-top: 15px;">
                <button id="add-btn" class="tab-btn active-tab" style="flex:2; height: 50px;" onclick="saveProduct()">Save Product to Store</button>
                <button id="cancel-btn" class="tab-btn" style="flex:1; display:none; background:#ccc;" onclick="resetProductForm()">Cancel Edit</button>
            </div>
        </div>

        <div class="card" style="overflow-x:auto;">
            <h3><i class="fas fa-warehouse" style="color:var(--orange)"></i> Current Inventory Stats</h3>
            <table>
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Product Details</th>
                        <th>Pricing</th>
                        <th>Stock Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-rows"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient("https://rzmftpafcyxburlkwqnm.supabase.co", "sb_publishable_zt4Wt4wBgarEU15zF-RoKw_4achnceD");

    function checkAuth() {
        if (document.getElementById('admin_pass').value === "Ahimsa Paramo Dharam") {
            document.getElementById('auth-overlay').style.display = 'none';
            loadData();
        } else { alert("Unauthorized Access! Verification Failed."); }
    }

    function toggleVisibility() {
        const pInput = document.getElementById('admin_pass');
        pInput.type = pInput.type === "password" ? "text" : "password";
        document.getElementById('togglePass').classList.toggle('fa-eye-slash');
    }

    function openTab(tab) {
        document.getElementById('orders-sec').style.display = tab === 'orders' ? 'block' : 'none';
        document.getElementById('products-sec').style.display = tab === 'products' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById('tab-' + tab).classList.add('active-tab');
    }

    async function loadData() {
        const { data: orders } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
        const { data: products } = await _supabase.from('products').select('*').order('created_at', { ascending: false });
        
        // Render Orders
        if (orders) {
            document.getElementById('total-revenue').innerText = '₹' + orders.reduce((sum, o) => sum + (Number(o.amount) || 0), 0);
            document.getElementById('total-orders').innerText = orders.length;
            document.getElementById('order-rows').innerHTML = orders.map(o => `
                <tr>
                    <td><small>${new Date(o.created_at).toLocaleDateString()}</small></td>
                    <td><b>${o.user_name}</b><br><small><i class="fab fa-whatsapp"></i> ${o.user_whatsapp}</small></td>
                    <td><div style="max-height:60px; overflow-y:auto; font-size:11px;">${o.order_details ? o.order_details.replace(/%0A/g, '<br>') : ''}</div></td>
                    <td>₹${o.amount}<br><small style="color:blue">UTR: ${o.utr_number}</small></td>
                    <td>
                        <select onchange="updateOrder('${o.id}', 'status', this.value)" style="padding:5px; width:auto; font-size:12px;">
                            <option ${o.status=='Pending'?'selected':''}>Pending</option>
                            <option ${o.status=='Verified'?'selected':''}>Verified</option>
                            <option ${o.status=='Shipped'?'selected':''}>Shipped</option>
                            <option ${o.status=='Delivered'?'selected':''}>Delivered</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" placeholder="Courier" value="${o.courier_name || ''}" onblur="updateOrder('${o.id}', 'courier_name', this.value)" style="margin-bottom:2px; padding:5px; font-size:11px;">
                        <input type="text" placeholder="Tracking Link" value="${o.tracking_url || ''}" onblur="updateOrder('${o.id}', 'tracking_url', this.value)" style="padding:5px; font-size:11px;">
                    </td>
                    <td><button class="btn-delete" onclick="deleteRow('orders', '${o.id}')"><i class="fas fa-trash-alt"></i></button></td>
                </tr>
            `).join('');
        }

        // Render Inventory
        if (products) {
            document.getElementById('total-products').innerText = products.length;
            document.getElementById('inventory-rows').innerHTML = products.map(p => {
                const safeJson = JSON.stringify(p).replace(/'/g, "&apos;");
                return `
                <tr>
                    <td><img src="${p.image_url}" class="prod-img-preview" onerror="this.src='https://via.placeholder.com/60'"></td>
                    <td><b>${p.name}</b><br><small style="color:#777">${p.category || 'General'}</small></td>
                    <td><del style="color:red; font-size:11px;">₹${p.original_price}</del><br><b>₹${p.price}</b></td>
                    <td><span style="padding:4px 8px; border-radius:15px; font-size:10px; font-weight:bold; background:${p.stock_status === 'In Stock' ? '#e8f5e9' : '#ffebee'}; color:${p.stock_status === 'In Stock' ? 'green' : 'red'}">${p.stock_status.toUpperCase()}</span></td>
                    <td>
                        <button class="btn-edit" onclick='prepareEdit(${safeJson})'><i class="fas fa-pen-nib"></i> Edit</button>
                        <button class="btn-delete" onclick="deleteRow('products', '${p.id}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
    }

    function prepareEdit(p) {
        document.getElementById('form-title').innerText = "Updating: " + p.name;
        document.getElementById('edit-p-id').value = p.id;
        document.getElementById('p_name').value = p.name;
        document.getElementById('p_original').value = p.original_price;
        document.getElementById('p_price').value = p.price;
        document.getElementById('p_category').value = p.category || "";
        document.getElementById('p_stock').value = p.stock_status;
        document.getElementById('p_free_shipping').value = p.is_free_shipping ? "true" : "false";
        document.getElementById('p_img').value = p.image_url;
        document.getElementById('img-preview-box').src = p.image_url;
        document.getElementById('p_description').value = p.description || "";
        
        document.getElementById('add-btn').innerText = "Apply Changes & Update Store";
        document.getElementById('add-btn').style.background = "var(--edit-blue)";
        document.getElementById('cancel-btn').style.display = "block";
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function saveProduct() {
        const id = document.getElementById('edit-p-id').value;
        const productData = {
            name: document.getElementById('p_name').value,
            original_price: document.getElementById('p_original').value || 0,
            price: document.getElementById('p_price').value,
            category: document.getElementById('p_category').value,
            stock_status: document.getElementById('p_stock').value,
            is_free_shipping: document.getElementById('p_free_shipping').value === "true",
            image_url: document.getElementById('p_img').value,
            description: document.getElementById('p_description').value
        };

        if(!productData.name || !productData.price) return alert("Error: Product Name and Sale Price are mandatory!");

        let result;
        if (id) {
            result = await _supabase.from('products').update(productData).eq('id', id);
        } else {
            result = await _supabase.from('products').insert([productData]);
        }

        if (result.error) {
            alert("Database Error: " + result.error.message);
        } else {
            alert(id ? "Success: Product details updated!" : "Success: New product launched in store!");
            resetProductForm();
            loadData();
        }
    }

    function resetProductForm() {
        document.getElementById('form-title').innerText = "Add New Product";
        document.getElementById('edit-p-id').value = "";
        document.getElementById('p_name').value = "";
        document.getElementById('p_original').value = "";
        document.getElementById('p_price').value = "";
        document.getElementById('p_category').value = "";
        document.getElementById('p_img').value = "";
        document.getElementById('img-preview-box').src = "";
        document.getElementById('p_description').value = "";
        document.getElementById('p_stock').selectedIndex = 0;
        document.getElementById('p_free_shipping').selectedIndex = 0;
        
        document.getElementById('add-btn').innerText = "Save Product to Store";
        document.getElementById('add-btn').style.background = "var(--orange)";
        document.getElementById('cancel-btn').style.display = "none";
    }

    async function updateOrder(id, field, value) {
        const d = {}; d[field] = value;
        const { error } = await _supabase.from('orders').update(d).eq('id', id);
        if(error) alert("Status Update Failed: " + error.message);
    }

    async function deleteRow(table, id) {
        if(confirm("Action Required: Are you sure you want to permanently delete this " + table.slice(0,-1) + "?")) {
            const { error } = await _supabase.from(table).delete().eq('id', id);
            if(error) alert("Deletion Failed: " + error.message);
            else loadData();
        }
    }
</script>
</body>
</html>
